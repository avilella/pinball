use strict;
use Getopt::Long;

my ($inputfile,$debug,$minmax);
$minmax = '3:4:5:6';

GetOptions(
	   'i|input|inputfile:s' => \$inputfile,
	   'minmax:s' => \$minmax,
           'debug' => \$debug,
          );

# ifile="/home/avilella/00x/osn_mmu07.clusters.factorset.tsv"
# ifile="/home/avilella/00x/oskm_hsap.clusters.factorset.c20.tsv"

open FILE, $inputfile or die $!;
my @colnames;
my $hash;
while (<FILE>) {
    chomp $_;
    if ($_ =~ /cluster_id/) {
        my $count = 1;
        foreach my $colname (split("\t",$_)) {
            $hash->{$count++}{colname} = $colname;
        }
    } else {
        foreach my $threshold (split(":",$minmax)) {
            my $count = 1;
            my $set = '';
            foreach my $value (split("\t",$_)) {
                if ($value >= $threshold) {
                    $set .= $hash->{$count}{colname} . " ";
                }
                $count++;
            }
            $hash->{sets}{$threshold}{$set}++;
            $hash->{total}{$threshold}++;
        }
    }
}

print join("\t","fsize","set","value"), "\n";
foreach my $threshold (sort {$a <=> $b} keys %{$hash->{sets}}) {
    foreach my $set (keys %{$hash->{sets}{$threshold}}) {
        my $value = $hash->{sets}{$threshold}{$set};
        $set = 'null' if ($set eq '');
        my @values = split(" ",$set);
        $DB::single=1;1;
        my $sortedset = join(' ',sort(@values));
        print join("\t",$threshold,$sortedset,$value), "\n";
    }
}
$DB::single=1;1;


# ifile="/home/avilella/00x/osn_mmu07.clusters.factorset.tsv"
# min     3
# total   4258
# S       7
# NO      62
# O       13
# NOS     3773
# OS      194
# N       65
# NS      144
# min     4
# total   4258
# S       9
# O       16
# NO      130
# NOS     3497
# N       95
# OS      318
# NS      193
# min     5
# total   4258
# S       19
# O       37
# NO      228
# NOS     3098
# OS      488
# N       131
# NS      257
# min     6
# total   4258
# S       55
# O       95
# NO      327
# NOS     2623
# OS      637
# N       193
# NS      328
# min     7
# total   4258
# S       133
# O       213
# NO      407
# NOS     2125
# OS      749
# N       281
# NS      350
# min     8
# total   4258
# null    26
# S       255
# O       413
# N       407
# NS      304
# NOS     1772
# NO      382
# OS      699
# min     9
# total   4258
# null    191
# S       367
# O       567
# N       487
# NS      230
# NOS     1521
# NO      312
# OS      583
# min     10
# total   4258
# S       417
# null    465
# O       619
# N       513
# NS      182
# NOS     1314
# NO      268
# OS      480
# min     11
# total   4258
# S       395
# null    817
# O       593
# N       513
# NS      153
# NOS     1151
# NO      237
# OS      399
# min     12
# total   4258
# S       344
# null    1173
# O       552
# N       484
# NS      123
# NOS     1034
# NO      201
# OS      347
# min     13
# total   4258
# S       306
# null    1482
# O       481
# N       465
# NS      102
# NOS     952
# NO      161
# OS      309
# min     14
# total   4258
# S       263
# null    1763
# O       438
# N       437
# NS      95
# NOS     849
# NO      143
# OS      270
# min     15
# total   4258
# S       230
# null    2001
# O       391
# N       410
# NS      81
# NOS     778
# NO      125
# OS      242
# min     16
# total   4258
# S       201
# null    2202
# O       357
# N       375
# NS      69
# NOS     720
# NO      109
# OS      225
# min     17
# total   4258
# S       189
# null    2378
# O       338
# N       330
# NS      59
# NOS     671
# NO      101
# OS      192
# min     18
# total   4258
# S       155
# null    2535
# O       310
# N       304
# NS      53
# NOS     632
# NO      99
# OS      170
# min     19
# total   4258
# S       134
# null    2671
# O       283
# N       276
# NS      49
# NOS     587
# NO      97
# OS      161
# min     20
# total   4258
# S       115
# null    2791
# O       259
# N       249
# NS      48
# NOS     553
# NO      99

# ifile="/home/avilella/00x/oskm_hsap.clusters.factorset.c20.tsv"

# min	3
# total	128266
# S	27
# O	36
# MO	1220
# MS	265
# KO	2305
# K	33
# KS	187
# KMS	1341
# KM	1481
# KMO	19939
# KOS	14125
# M	341
# OS	1455
# KMOS	77899
# MOS	7612
# min	4
# total	128266
# S	327
# O	231
# MO	3087
# MS	914
# KO	6659
# K	170
# KS	862
# KMS	2251
# KM	2845
# KMO	23042
# M	951
# KOS	19097
# OS	5235
# KMOS	51680
# MOS	10915
# min	5
# total	128266
# S	1670
# O	1577
# MO	6120
# MS	2098
# KO	13054
# K	757
# KS	2376
# KMS	2232
# KM	4608
# KMO	20587
# M	2187
# KOS	17596
# OS	11073
# KMOS	32077
# MOS	10254
# min	6
# total	128266
# null	60
# S	5459
# MS	2723
# K	2966
# KS	3252
# KMO	15101
# M	4696
# OS	14797
# MOS	7050
# O	6399
# MO	8105
# KO	17205
# KMS	1279
# KM	5826
# KOS	12125
# KMOS	21223
# min	7
# total	128266
# null	2422
# S	10606
# MS	2170
# KS	2563
# K	6809
# KMO	10771
# M	8088
# OS	13573
# MOS	4659
# O	14214
# MO	7312
# KO	16068
# KMS	701
# KM	5281
# KOS	7950
# KMOS	15079
# min	8
# total	128266
# null	10835
# S	13938
# MS	1447
# KS	1551
# K	9492
# KMO	7977
# M	10358
# OS	10382
# MOS	3230
# O	19353
# MO	5592
# KO	12773
# KMS	440
# KM	4143
# KOS	5463
# KMOS	11292
# min	9
# total	128266
# S	14416
# null	24491
# MS	999
# KS	1009
# K	9892
# KMO	6120
# M	11131
# OS	7716
# MOS	2369
# O	20164
# MO	4173
# KO	9616
# KMS	287
# KM	3125
# KOS	3966
# KMOS	8792
# min	10
# total	128266
# S	13223
# null	39904
# MS	666
# KS	691
# K	9085
# KMO	4861
# M	10859
# OS	5829
# MOS	1843
# O	17964
# MO	3184
# KO	7361
# KMS	215
# KM	2467
# KOS	2995
# KMOS	7119
# min	11
# total	128266
# S	11384
# null	54271
# MS	482
# KS	481
# K	7794
# KMO	3999
# M	10151
# OS	4583
# MOS	1425
# O	14974
# MO	2598
# KO	5819
# KMS	137
# KM	1939
# KOS	2336
# KMOS	5893
# min	12
# total	128266
# S	9442
# null	66491
# MS	385
# KS	338
# K	6551
# KMO	3349
# M	9336
# OS	3691
# MOS	1122
# O	12196
# MO	2147
# KO	4742
# KMS	75
# KM	1587
# KOS	1827
# KMOS	4987
# min	13
# total	128266
# S	7897
# null	76223
# MS	283
# KS	248
# K	5494
# KMO	2795
# M	8529
# OS	3054
# MOS	902
# O	9985
# MO	1796
# KO	3902
# KMS	49
# KM	1301
# KOS	1484
# KMOS	4324
# min	14
# total	128266
# S	6619
# null	84033
# MS	223
# KS	195
# K	4617
# KMO	2403
# M	7812
# OS	2523
# MOS	720
# O	8239
# MO	1483
# KO	3256
# KMS	40
# KM	1092
# KOS	1228
# KMOS	3783
# min	15
# total	128266
# S	5532
# null	90477
# MS	173
# KS	147
# K	3914
# KMO	2048
# M	7015
# OS	2121
# MOS	597
# O	6797
# MO	1296
# KO	2764
# KMS	35
# KM	934
# KOS	1046
# KMOS	3370
# min	16
# total	128266
# S	4682
# null	95686
# MS	149
# KS	103
# K	3332
# KMO	1750
# M	6313
# OS	1769
# MOS	531
# O	5697
# MO	1118
# KO	2393
# KMS	31
# KM	820
# KOS	869
# KMOS	3023
# min	17
# total	128266
# S	3959
# null	99928
# MS	128
# KS	67
# K	2800
# KMO	1537
# M	5742
# OS	1550
# MOS	460
# MO	962
# O	4828
# KO	2104
# KMS	27
# KM	678
# KOS	747
# KMOS	2749
# min	18
# total	128266
# S	3381
# null	103289
# MS	104
# KS	56
# K	2429
# KMO	1364
# M	5233
# OS	1344
# MOS	407
# MO	846
# O	4170
# KO	1879
# KMS	20
# KM	589
# KOS	663
# KMOS	2492
# min	19
# total	128266
# S	2874
# null	106132
# MS	92
# KS	46
# K	2150
# KMO	1199
# M	4765
# OS	1187
# MOS	356
# MO	792
# O	3615
# KO	1635
# KMS	15
# KM	511
# KOS	596
# KMOS	2301
# min	20
# total	128266
# S	2486
# null	108466
# MS	80
# KS	38
# K	1879
# KMO	1077
# M	4356
# OS	1047
# MOS	322
# MO	706
# O	3224
# KO	1452
# KMS	10
# KM	452
# KOS	534
# KMOS	2137
